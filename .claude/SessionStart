#!/bin/bash
# SessionStart hook for IBDM project
# This runs automatically at the start of every Claude Code session

set -e

echo "üîß IBDM Environment Setup"
echo "=========================="

# 1. Install dependencies
echo "üì¶ Installing dependencies..."
uv pip install --system -e . > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úì Dependencies installed"
else
    echo "‚úó Failed to install dependencies"
    exit 1
fi

# 2. Install beads task tracker
echo "üìã Installing beads..."
if ! command -v bd &> /dev/null; then
    GOTOOLCHAIN=auto go install github.com/steveyegge/beads/cmd/bd@latest > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "‚úì beads installed"
    else
        echo "‚ö†Ô∏è  beads installation failed (task tracking unavailable)"
    fi
else
    echo "‚úì beads already installed"
fi

# 3. Verify core imports
echo "üîç Verifying imports..."
python -c "from ibdm.core import InformationState; from ibdm.nlu import NLUContext; from ibdm.engine import DialogueMoveEngine" 2>/dev/null
if [ $? -eq 0 ]; then
    echo "‚úì Core imports working"
else
    echo "‚úó Import verification failed"
    exit 1
fi

# 4. Verify tools
echo "üõ†Ô∏è  Verifying tools..."
python -m pytest --version > /dev/null 2>&1 && echo "‚úì pytest available"
python -m ruff --version > /dev/null 2>&1 && echo "‚úì ruff available"
python -m pyright --version > /dev/null 2>&1 && echo "‚úì pyright available"

# 5. Check API key (non-blocking)
echo "üîë Checking API key..."
python -c "import os; assert os.getenv('IBDM_API_KEY'), 'Missing IBDM_API_KEY'" 2>/dev/null
if [ $? -eq 0 ]; then
    echo "‚úì IBDM_API_KEY configured"
else
    echo "‚ö†Ô∏è  IBDM_API_KEY not set (LLM features will not work)"
fi

echo ""
echo "‚úÖ IBDM environment ready!"
echo ""
